From 1f5937d288c3d3c409a4517a34b1662678edfb57 Mon Sep 17 00:00:00 2001
From: emeraldocean123 <emeraldocean123@users.noreply.github.com>
Date: Tue, 12 Aug 2025 01:46:44 -0500
Subject: [PATCH] feat: Deploy MSI laptop configuration with Plasma desktop

  - Configure NVIDIA RTX 2070 with open kernel modules
  - Update KDE packages for Qt6 compatibility
  - Enable unfree packages for NVIDIA drivers
  - Update hardware configuration for MSI GE75 Raider
  - Comment out problematic udev rules temporarily
---
 flake.lock                                    | 22 +++---------
 hosts/msi-ge75-raider-nixos/configuration.nix |  1 +
 .../hardware-configuration.nix                | 36 +++++++++++--------
 modules/msi-ge75-raider-nixos/hardware.nix    | 12 +++----
 modules/msi-ge75-raider-nixos/nvidia.nix      | 33 ++++++++++-------
 modules/msi-ge75-raider-nixos/packages.nix    |  6 ++--
 6 files changed, 56 insertions(+), 54 deletions(-)

diff --git a/flake.lock b/flake.lock
index f28c706..45877fb 100644
--- a/flake.lock
+++ b/flake.lock
@@ -3,7 +3,9 @@
     "dotfiles": {
       "inputs": {
         "home-manager": "home-manager",
-        "nixpkgs": "nixpkgs"
+        "nixpkgs": [
+          "nixpkgs"
+        ]
       },
       "locked": {
         "lastModified": 1754808670,
@@ -62,22 +64,6 @@
       }
     },
     "nixpkgs": {
-      "locked": {
-        "lastModified": 1754725699,
-        "narHash": "sha256-iAcj9T/Y+3DBy2J0N+yF9XQQQ8IEb5swLFzs23CdP88=",
-        "owner": "NixOS",
-        "repo": "nixpkgs",
-        "rev": "85dbfc7aaf52ecb755f87e577ddbe6dbbdbc1054",
-        "type": "github"
-      },
-      "original": {
-        "owner": "NixOS",
-        "ref": "nixos-unstable",
-        "repo": "nixpkgs",
-        "type": "github"
-      }
-    },
-    "nixpkgs_2": {
       "locked": {
         "lastModified": 1754563854,
         "narHash": "sha256-YzNTExe3kMY9lYs23mZR7jsVHe5TWnpwNrsPOpFs/b8=",
@@ -97,7 +83,7 @@
       "inputs": {
         "dotfiles": "dotfiles",
         "home-manager": "home-manager_2",
-        "nixpkgs": "nixpkgs_2"
+        "nixpkgs": "nixpkgs"
       }
     }
   },
diff --git a/hosts/msi-ge75-raider-nixos/configuration.nix b/hosts/msi-ge75-raider-nixos/configuration.nix
index 333d004..7ae29d6 100644
--- a/hosts/msi-ge75-raider-nixos/configuration.nix
+++ b/hosts/msi-ge75-raider-nixos/configuration.nix
@@ -13,6 +13,7 @@
     ../../modules/msi-ge75-raider-nixos/users.nix
     ./hardware-configuration.nix
   ];
+  nixpkgs.config.allowUnfree = true;
   boot.loader = {
     systemd-boot.enable = true;
     efi.canTouchEfiVariables = true;
diff --git a/hosts/msi-ge75-raider-nixos/hardware-configuration.nix b/hosts/msi-ge75-raider-nixos/hardware-configuration.nix
index e9e1637..3668110 100644
--- a/hosts/msi-ge75-raider-nixos/hardware-configuration.nix
+++ b/hosts/msi-ge75-raider-nixos/hardware-configuration.nix
@@ -1,34 +1,40 @@
-## hosts/msi-ge75-raider-nixos/hardware-configuration.nix
-# Generated by nixos-generate-config. Do not modify; edit configuration.nix instead.
+# Do not modify this file!  It was generated by ‘nixos-generate-config’
+# and may be overwritten by future invocations.  Please make changes
+# to /etc/nixos/configuration.nix instead.
 { config, lib, pkgs, modulesPath, ... }:
 
 {
   imports =
-    [
-      (modulesPath + "/installer/scan/not-detected.nix")
+    [ (modulesPath + "/installer/scan/not-detected.nix")
     ];
 
-  boot.initrd.availableKernelModules = [ "xhci_pci" "nvme" "ahci" "usb_storage" "sd_mod" ];
+  boot.initrd.availableKernelModules = [ "xhci_pci" "ahci" "nvme" "usb_storage" "sd_mod" "rtsx_usb_sdmmc" ];
   boot.initrd.kernelModules = [ ];
   boot.kernelModules = [ "kvm-intel" ];
   boot.extraModulePackages = [ ];
 
-  # Bootloader configured in hosts/msi-ge75-raider-nixos/configuration.nix (systemd-boot)
-
-  # Temporary placeholder for root filesystem (replace UUID and device after install)
   fileSystems."/" =
-    {
-      device = "/dev/disk/by-uuid/00000000-0000-0000-0000-000000000000"; # Placeholder UUID - replace with real from blkid
+    { device = "/dev/disk/by-uuid/6e49b974-32d4-443b-bb4f-c9628106f47a";
       fsType = "ext4";
     };
 
-  # Temporary placeholder for swap (optional; comment out if no swap, or replace after install)
-  # swapDevices =
-  #   [ { device = "/dev/disk/by-uuid/00000000-0000-0000-0000-000000000000"; }  # Placeholder - replace or remove
-  #   ];
+  fileSystems."/boot" =
+    { device = "/dev/disk/by-uuid/08DA-79B4";
+      fsType = "vfat";
+      options = [ "fmask=0077" "dmask=0077" ];
+    };
+
+  swapDevices =
+    [ { device = "/dev/disk/by-uuid/7da81dcb-243d-4949-9fd4-09646fb944fc"; }
+    ];
 
-  # Enables DHCP on each ethernet and wireless interface.
+  # Enables DHCP on each ethernet and wireless interface. In case of scripted networking
+  # (the default) this is the recommended approach. When using systemd-networkd it's
+  # still possible to use this option, but it's recommended to use it in conjunction
+  # with explicit per-interface declarations with `networking.interfaces.<interface>.useDHCP`.
   networking.useDHCP = lib.mkDefault true;
+  # networking.interfaces.enp6s0.useDHCP = lib.mkDefault true;
+  # networking.interfaces.wlp3s0f0.useDHCP = lib.mkDefault true;
 
   nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
   hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
diff --git a/modules/msi-ge75-raider-nixos/hardware.nix b/modules/msi-ge75-raider-nixos/hardware.nix
index 5f67454..63f2c17 100644
--- a/modules/msi-ge75-raider-nixos/hardware.nix
+++ b/modules/msi-ge75-raider-nixos/hardware.nix
@@ -47,10 +47,10 @@
   # Performance monitoring: add sensors/SMART in host config if needed
 
   # Enable USB devices (gaming peripherals)
-  services.udev.extraRules = ''
-    # Gaming mouse/keyboard permissions
-    SUBSYSTEM=="usb", ATTRS{idVendor}=="046d", MODE="0666"  # Logitech
-    SUBSYSTEM=="usb", ATTRS{idVendor}=="1532", MODE="0666"  # Razer
-    SUBSYSTEM=="usb", ATTRS{idVendor}=="0b05", MODE="0666"  # ASUS
-  '';
+    # services.udev.extraRules = ''
+    #   # Gaming mouse/keyboard permissions
+    #   SUBSYSTEM=="usb", ATTRS{idVendor}=="046d", MODE="0666"  # Logitech
+    #   SUBSYSTEM=="usb", ATTRS{idVendor}=="1532", MODE="0666"  # Razer
+    #   SUBSYSTEM=="usb", ATTRS{idVendor}=="0b05", MODE="0666"  # ASUS
+    # '';
 }
diff --git a/modules/msi-ge75-raider-nixos/nvidia.nix b/modules/msi-ge75-raider-nixos/nvidia.nix
index 14c5c4f..0856ad7 100644
--- a/modules/msi-ge75-raider-nixos/nvidia.nix
+++ b/modules/msi-ge75-raider-nixos/nvidia.nix
@@ -1,12 +1,21 @@
-# modules/msi-ge75-raider-nixos/nvidia.nix
-# NVIDIA driver configuration for MSI GE75 Raider (RTX 2070)
-{ config, pkgs, ... }:
-{
-  services.xserver.videoDrivers = [ "nvidia" ];
-  hardware.nvidia = {
-    modesetting.enable = true;
-    powerManagement.enable = true;
-    nvidiaSettings = true;
-    package = config.boot.kernelPackages.nvidiaPackages.production;
-  };
-}
+## modules/msi-ge75-raider-nixos/nvidia.nix
+  # NVIDIA configuration for MSI GE75 Raider
+  { config, pkgs, ... }:
+  {
+    # Enable proprietary NVIDIA drivers
+    hardware.graphics.enable = true;
+    hardware.nvidia = {
+      modesetting.enable = true;
+      powerManagement.enable = false;
+      powerManagement.finegrained = false;
+
+      # Use open source kernel modules for RTX series
+      # Set to false for older GPUs (pre-Turing)
+      open = true;  # MSI GE75 Raider typically has RTX 2060/2070
+
+      nvidiaSettings = true;
+      package = config.boot.kernelPackages.nvidiaPackages.stable;
+    };
+
+    services.xserver.videoDrivers = [ "nvidia" ];
+  }
diff --git a/modules/msi-ge75-raider-nixos/packages.nix b/modules/msi-ge75-raider-nixos/packages.nix
index 508e4f0..32f81d0 100644
--- a/modules/msi-ge75-raider-nixos/packages.nix
+++ b/modules/msi-ge75-raider-nixos/packages.nix
@@ -15,9 +15,9 @@
   # Theming and icons (Plasma-friendly)
   nixos-icons
   papirus-icon-theme
-  breeze-icons
-  breeze-gtk
-  xdg-desktop-portal-kde
+  kdePackages.breeze-icons
+  kdePackages.breeze-gtk
+  kdePackages.xdg-desktop-portal-kde
 
   # Terminal and helpers
     kitty
-- 
2.50.1

